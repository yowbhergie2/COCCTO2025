<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- PAKI-DAGDAG: Font Awesome para sa error icon sa modal -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      /* Background is transparent to let overlay show */
      background: transparent; 
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: #1a1f36;
    }
    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e8ebed;
      border-radius: 8px;
      font-size: 0.9375rem;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
    }
    .form-input:focus {
      outline: none;
      /* Updated Theme: Indigo Focus Ring */
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    /* Add style for disabled input */
    .form-input:disabled {
      background-color: #f8f9fa; /* Lighter gray */
      color: #697386;
      cursor: not-allowed;
    }
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9375rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn-primary {
      /* Updated Theme: Indigo Gradient */
      background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
      color: white;
    }
    .btn-primary:hover {
      /* Updated Theme: Indigo Shadow */
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: white;
      color: #1a1f36;
      border: 1px solid #e8ebed;
    }
    .btn-secondary:hover {
      /* Updated Theme: Indigo Light Hover */
      border-color: #4f46e5;
      color: #4f46e5;
      background: #f5f3ff;
    }
  </style>
</head>
<body>
  <!-- 
    FIX: Added white background, border-radius, and shadow to this container 
    to fix the transparency issue from the screenshot.
    
    *** PAKI-AYOS (START): Ginawang responsive ang width ***
  -->
  <div style="
    width: 90%; /* Ginawang responsive */
    max-width: 700px; /* Itinakda ang maximum width */
    padding: 2rem; 
    background: white; 
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    /* Ang margin auto ay tinanggal dahil ang overlay na ang nagse-center (justify-content: center) */
  ">
  <!-- *** PAKI-AYOS (END) *** -->

    <div style="margin-bottom: 2rem;">
      <h2 style="font-size: 1.5rem; font-weight: 700; color: #1a1f36; margin-bottom: 0.5rem;">Log Historical Balance</h2>
      <p style="color: #697386; font-size: 0.9375rem; margin-bottom: 1rem;">Enter historical COC data for initial system setup</p>
      <!-- PAKI-AYOS: Inalis yung formula sa note -->
      <div style="background: #e6f3ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 1rem;">
        <p style="font-size: 0.875rem; color: #1e40af; margin: 0;">
          <strong>Note:</strong> This tool is for migrating existing balances from the old system.
        </p>
      </div>
    </div>

    <!-- Success/Error Messages (moved to top for better visibility) -->
    <div id="messageContainer" style="margin-bottom: 1.5rem; display: none;"></div>

    <form id="historyForm" onsubmit="return handleFormSubmit(event)">
      <!-- 
        TINANGGAL: Employee Selection Dropdown.
        PINALITAN: Hidden input. Ang value nito ay ise-set ng 'EmployeesScript'
      -->
      <input type="hidden" name="employeeId" id="employeeId" value="">

      <!-- Month and Year -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
        <div>
          <label class="form-label">Earned Month <span style="color: #ef4444;">*</span></label>
          <!-- BAGONG-DAGDAG: onchange event -->
          <select name="month" id="month" required class="form-input" onchange="updateIssuanceDateConstraints()">
            <option value="">-- Select Month --</option>
            <option value="January">January</option>
            <option value="February">February</option>
            <option value="March">March</option>
            <option value="April">April</option>
            <option value="May">May</option>
            <option value="June">June</option>
            <option value="July">July</option>
            <option value="August">August</option>
            <option value="September">September</option>
            <option value="October">October</option>
            <option value="November">November</option>
            <option value="December">December</option>
          </select>
        </div>
        <div>
          <label class="form-label">Earned Year <span style="color: #ef4444;">*</span></label>
          <!-- SERVER-SIDE POPULATED YEARS -->
          <!-- BAGONG-DAGDAG: onchange event -->
          <select name="year" id="year" required class="form-input" onchange="updateIssuanceDateConstraints()">
            <?!= typeof yearOptions !== 'undefined' ? yearOptions : '<option value="">-- Select Year --</option><option value="2025">2025</option><option value="2024">2024</option>' ?>
          </select>
        </div>
      </div>

      <!-- COC Earned and Used -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
        <div>
          <label class="form-label">COC Earned (hours) <span style="color: #ef4444;">*</span></label>
          <input type="number" name="cocEarned" id="cocEarned" required 
                 min="0" max="40" step="0.5" class="form-input"
                 oninput="calculateRemaining()">
          <p style="font-size: 0.8125rem; color: #697386; margin-top: 0.25rem;">Maximum: 40 hours per month</p>
        </div>
        <div>
          <label class="form-label">COC Used (hours) <span style="color: #ef4444;">*</span></label>
          <input type="number" name="cocUsed" id="cocUsed" required 
                 min="0" step="0.5" value="0" class="form-input"
                 oninput="calculateRemaining()">
        </div>
      </div>

      <!-- Remaining Balance (calculated) -->
      <div style="background: #f5f3ff; border: 1px solid #c7d2fe; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 0.875rem; font-weight: 600; color: #1a1f36;">Remaining Balance:</span>
          <!-- Updated Theme: Indigo Text -->
          <span id="remainingBalance" style="font-size: 1.5rem; font-weight: 700; color: #4338ca;">0.0 hours</span>
        </div>
      </div>

      <!-- Date of Issuance -->
      <div style="margin-bottom: 1rem;">
        <label class="form-label">Date of Issuance (Certificate Date) <span style="color: #ef4444;">*</span></label>
        <!-- BAGONG-DAGDAG: disabled by default, onchange event -->
        <input type="date" name="dateOfIssuance" id="dateOfIssuance" required class="form-input"
               onchange="calculateValidUntil()" disabled>
        <!-- BAGONG-DAGDAG: Updated help text -->
        <p style="font-size: 0.8125rem; color: #697386; margin-top: 0.25rem;" id="dateIssuanceHelpText">
          Please select Earned Month and Year first. Date must be in the selected year.
        </p>
      </div>

      <!-- Valid Until (calculated) -->
      <!-- PAKI-AYOS: Inalis yung formula <p> tag -->
      <div id="validUntilContainer" style="display: none; background: #e6f3ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 0.875rem; font-weight: 600; color: #1e40af;">Credits Valid Until:</span>
          <span id="validUntilDate" style="font-size: 1.125rem; font-weight: 700; color: #1e40af;">--</span>
        </div>
      </div>

      <!-- Action Buttons -->
      <div style="display: flex; gap: 0.75rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #e8ebed;">
        <button type="button" onclick="hideOverlay()" class="btn btn-secondary">Cancel</button>
        <button type="submit" id="saveBtn" class="btn btn-primary">Save Historical Balance</button>
      </div>
    </form>

    <!-- PAKI-DAGDAG: Error Modal Structure -->
    <div id="errorModal" style="
      display: none; /* Hidden by default */
      position: fixed; 
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.4); /* Dim background */
      z-index: 200; /* On top of the form */
      justify-content: center;
      align-items: center;
      /* Tiniyak na ang padding ay nasa modal container, hindi sa overlay */
      padding: 1rem; 
    ">
      <div style="
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        width: 90%;
        max-width: 450px;
        text-align: center;
      ">
        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;"></i>
        <h3 style="font-size: 1.25rem; font-weight: 600; color: #1a1f36; margin-bottom: 0.5rem;">Error</h3>
        <p id="errorModalMessage" style="color: #697386; font-size: 0.9375rem; margin-bottom: 1.5rem;">
          <!-- Error message goes here -->
        </p>
        <button type="button" onclick="hideErrorModal()" class="btn btn-primary" style="background: #ef4444; width: 100%; justify-content: center;">
          Okay
        </button>
      </div>
    </div>
    <!-- PAKI-DAGDAG (END) -->

  </div>

  <script>
    // Years are now populated server-side, no need for client-side population!

    // --- BAGONG-DAGDAG: Function to get month number ---
    function getMonthNumber(monthName) {
      const months = {
        'January': 0, 'February': 1, 'March': 2, 'April': 3,
        'May': 4, 'June': 5, 'July': 6, 'August': 7,
        'September': 8, 'October': 9, 'November': 10, 'December': 11
      };
      return months[monthName];
    }

    // --- BAGONG-DAGDAG: Function to format date as YYYY-MM-DD ---
    function formatDateForInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // --- BAGONG-DAGDAG: Function to update Date of Issuance constraints ---
    function updateIssuanceDateConstraints() {
      const monthSelect = document.getElementById('month');
      const yearSelect = document.getElementById('year');
      const dateInput = document.getElementById('dateOfIssuance');
      const helpText = document.getElementById('dateIssuanceHelpText');

      const month = monthSelect.value;
      const year = yearSelect.value;

      if (month && year) {
        // Enable the date input
        dateInput.disabled = false;

        // Calculate min date (last day of earned month)
        const monthIndex = getMonthNumber(month);
        const minDate = new Date(year, monthIndex + 1, 0); // Day 0 of next month = last day of current month
        minDate.setHours(0, 0, 0, 0);

        // Calculate max date (December 31 of earned year)
        const maxDate = new Date(year, 11, 31); // 11 = December
        maxDate.setHours(0, 0, 0, 0);

        const minDateStr = formatDateForInput(minDate);
        const maxDateStr = formatDateForInput(maxDate);

        // Set attributes
        dateInput.min = minDateStr;
        dateInput.max = maxDateStr;

        // Update help text
        helpText.textContent = `Date must be between ${minDateStr} and ${maxDateStr}.`;

        // Check if existing value is now invalid
        if (dateInput.value) {
          const currentDate = new Date(dateInput.value + 'T00:00:00');
          if (currentDate < minDate || currentDate > maxDate) {
            dateInput.value = ''; // Clear invalid date
            calculateValidUntil(); // Clear valid until display
          }
        }
      } else {
        // Disable if month or year is missing
        dateInput.disabled = true;
        dateInput.value = '';
        dateInput.min = '';
        dateInput.max = '';
        helpText.textContent = 'Please select Earned Month and Year first. Date must be in the selected year.';
        calculateValidUntil(); // Clear valid until display
      }
    }

    function calculateRemaining() {
      const earned = parseFloat(document.getElementById('cocEarned').value) || 0;
      const used = parseFloat(document.getElementById('cocUsed').value) || 0;
      const remaining = earned - used;

      const remainingDisplay = document.getElementById('remainingBalance');
      remainingDisplay.textContent = remaining.toFixed(1) + ' hours';

      // Visual feedback: turn red if negative
      if (remaining < 0) {
        remainingDisplay.style.color = '#ef4444'; // Red
        remainingDisplay.parentElement.parentElement.style.background = '#fee';
        remainingDisplay.parentElement.parentElement.style.borderColor = '#ef4444';
      } else {
        remainingDisplay.style.color = '#4338ca'; // Indigo
        remainingDisplay.parentElement.parentElement.style.background = '#f5f3ff';
        remainingDisplay.parentElement.parentElement.style.borderColor = '#c7d2fe';
      }

      // Validate that used doesn't exceed earned
      if (used > earned) {
        document.getElementById('cocUsed').setCustomValidity('COC Used cannot exceed COC Earned');
      } else {
        document.getElementById('cocUsed').setCustomValidity('');
      }
    }

    function calculateValidUntil() {
      const dateInput = document.getElementById('dateOfIssuance').value;
      
      // --- BAGONG-DAGDAG: Call constraint checker ---
      // This re-validates the date just in case it was typed manually
      updateIssuanceDateConstraints();

      if (!dateInput) {
        document.getElementById('validUntilContainer').style.display = 'none';
        return;
      }

      // Calculate Valid Until: (Date of Issuance + 1 Year) - 1 Day
      // Add T00:00:00 to avoid timezone issues
      const dateOfIssuance = new Date(dateInput + 'T00:00:00'); 
      const validUntil = new Date(dateOfIssuance);
      validUntil.setFullYear(validUntil.getFullYear() + 1);
      validUntil.setDate(validUntil.getDate() - 1);

      // Format date as MM/DD/YYYY
      const formatted = (validUntil.getMonth() + 1).toString().padStart(2, '0') + '/' +
                       validUntil.getDate().toString().padStart(2, '0') + '/' +
                       validUntil.getFullYear();

      document.getElementById('validUntilDate').textContent = formatted;
      document.getElementById('validUntilContainer').style.display = 'block';
    }

    // Form submission handler (called by inline onsubmit)
    function handleFormSubmit(e) {
      e.preventDefault();
      console.log('[HistoryForm] Form submitted, validating...');

      // *** VALIDATION: Manual validation before submitting ***
      const earnedInput = document.getElementById('cocEarned');
      const usedInput = document.getElementById('cocUsed');
      const earned = parseFloat(earnedInput.value) || 0;
      const used = parseFloat(usedInput.value) || 0;

      console.log('[HistoryForm] Earned:', earned, 'Used:', used);

      // Validate: COC Used cannot exceed COC Earned
      if (used > earned) {
        console.log('[HistoryForm] Validation FAILED: Used > Earned');
        showErrorModal('Error: COC Used (' + used + ' hours) cannot exceed COC Earned (' + earned + ' hours)');
        usedInput.focus();
        return false;
      }

      // Validate: COC Earned cannot exceed 40 hours
      if (earned > 40) {
        console.log('[HistoryForm] Validation FAILED: Earned > 40');
        showErrorModal('Error: COC Earned cannot exceed 40 hours per month');
        earnedInput.focus();
        return false;
      }
      
      // --- BAGONG-DAGDAG: Validate Date of Issuance again ---
      const dateInput = document.getElementById('dateOfIssuance');
      if (dateInput.disabled || !dateInput.value) {
          showErrorModal('Error: Please select a valid Date of Issuance.');
          dateInput.focus();
          return false;
      }
      // Re-check min/max constraints one last time
      const currentDate = new Date(dateInput.value + 'T00:00:00');
      const minDate = new Date(dateInput.min + 'T00:00:00');
      const maxDate = new Date(dateInput.max + 'T00:00:00');
      if (currentDate < minDate || currentDate > maxDate) {
          showErrorModal('Error: Date of Issuance is outside the allowed range (' + dateInput.min + ' to ' + dateInput.max + ').');
          dateInput.focus();
          return false;
      }
      // --- END ---

      console.log('[HistoryForm] Validation PASSED, submitting...');

      const formData = new FormData(document.getElementById('historyForm'));
      const data = Object.fromEntries(formData);

      // Kunin ang employeeId mula sa hidden input
      data.employeeId = document.getElementById('employeeId').value;

      if (!data.employeeId) {
        showErrorModal('Error: Employee ID is missing. Please close and reopen the form.');
        return false;
      }

      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            // Show success message briefly before closing
            const container = document.getElementById('messageContainer');
            if (container) {
              container.style.cssText = `
                background: #e0e7ff;
                border: 1px solid #4f46e5;
                color: #4338ca;
                padding: 1rem;
                border-radius: 8px;
                font-weight: 500;
                font-size: 0.9375rem;
                margin-bottom: 1.5rem;
                display: block;
              `;
              container.textContent = result.message;
              container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            setTimeout(() => {
              hideOverlay(true);
            }, 2000);
          } else {
            showErrorModal(result.message);
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Historical Balance';
          }
        })
        .withFailureHandler(err => {
          showErrorModal('Error: ' + err.message);
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Historical Balance';
        })
        .saveHistoricalBalance(data);
    }

    // Note: hideOverlay() function is provided by the parent scope (EmployeesScript)
    // No need to redefine it here

    // --- PAKI-DAGDAG: New functions for Error Modal ---
    function showErrorModal(message) {
      const modal = document.getElementById('errorModal');
      const modalMessage = document.getElementById('errorModalMessage');

      if (!modal || !modalMessage) {
        console.error('showErrorModal: Modal elements not found. Message:', message);
        alert(message);  // Fallback to browser alert
        return;
      }

      modalMessage.textContent = message;
      modal.style.display = 'flex'; // Show the modal
    }

    function hideErrorModal() {
      const modal = document.getElementById('errorModal');
      if (modal) {
        modal.style.display = 'none'; // Hide the modal
      }
    }
    // --- PAKI-DAGDAG (END) ---
  </script>
</body>
</html>

// LibraryService.gs - Master Data Management (Firestore Version)

/**
 * Get all offices from Firestore libraries collection
 */
function getAllOffices() {
  try {
    // Get the offices document from libraries collection
    const officesDoc = getDocument('libraries', 'offices');

    if (!officesDoc || !officesDoc.items) {
      return [];
    }

    return officesDoc.items || [];

  } catch (error) {
    Logger.log('Error in getAllOffices: ' + error.toString());
    return [];
  }
}

/**
 * Get all positions from Firestore libraries collection
 */
function getAllPositions() {
  try {
    // Get the positions document from libraries collection
    const positionsDoc = getDocument('libraries', 'positions');

    if (!positionsDoc || !positionsDoc.items) {
      return [];
    }

    return positionsDoc.items || [];

  } catch (error) {
    Logger.log('Error in getAllPositions: ' + error.toString());
    return [];
  }
}

/**
 * Add office to Libraries
 */
function addOffice(officeName) {
  try {
    if (!officeName || officeName.trim() === '') {
      return {
        success: false,
        message: 'Office name is required'
      };
    }

    const offices = getAllOffices();
    if (offices.includes(officeName)) {
      return {
        success: false,
        message: 'Office already exists'
      };
    }

    // Add to offices array
    offices.push(officeName);

    // Update Firestore document
    updateDocument('libraries', 'offices', {
      category: 'offices',
      items: offices
    });

    return {
      success: true,
      message: 'Office added successfully'
    };
  } catch (error) {
    return {
      success: false,
      message: 'Error adding office: ' + error.message
    };
  }
}

/**
 * Add position to Libraries
 */
function addPosition(positionName) {
  try {
    if (!positionName || positionName.trim() === '') {
      return {
        success: false,
        message: 'Position name is required'
      };
    }

    const positions = getAllPositions();
    if (positions.includes(positionName)) {
      return {
        success: false,
        message: 'Position already exists'
      };
    }

    // Add to positions array
    positions.push(positionName);

    // Update Firestore document
    updateDocument('libraries', 'positions', {
      category: 'positions',
      items: positions
    });

    return {
      success: true,
      message: 'Position added successfully'
    };
  } catch (error) {
    return {
      success: false,
      message: 'Error adding position: ' + error.message
    };
  }
}

/**
 * Update office name
 */
function updateOffice(oldName, newName) {
  try {
    if (!newName || newName.trim() === '') {
      return {
        success: false,
        message: 'Office name is required'
      };
    }

    const offices = getAllOffices();
    const index = offices.indexOf(oldName);

    if (index === -1) {
      return {
        success: false,
        message: 'Office not found'
      };
    }

    // Update the office name
    offices[index] = newName;

    // Update Firestore document
    updateDocument('libraries', 'offices', {
      category: 'offices',
      items: offices
    });

    return {
      success: true,
      message: 'Office updated successfully'
    };
  } catch (error) {
    return {
      success: false,
      message: 'Error updating office: ' + error.message
    };
  }
}

/**
 * Update position name
 */
function updatePosition(oldName, newName) {
  try {
    if (!newName || newName.trim() === '') {
      return {
        success: false,
        message: 'Position name is required'
      };
    }

    const positions = getAllPositions();
    const index = positions.indexOf(oldName);

    if (index === -1) {
      return {
        success: false,
        message: 'Position not found'
      };
    }

    // Update the position name
    positions[index] = newName;

    // Update Firestore document
    updateDocument('libraries', 'positions', {
      category: 'positions',
      items: positions
    });

    return {
      success: true,
      message: 'Position updated successfully'
    };
  } catch (error) {
    return {
      success: false,
      message: 'Error updating position: ' + error.message
    };
  }
}

/**
 * Delete office
 */
function deleteOffice(officeName) {
  try {
    const offices = getAllOffices();
    const index = offices.indexOf(officeName);

    if (index === -1) {
      return {
        success: false,
        message: 'Office not found'
      };
    }

    // Remove from array
    offices.splice(index, 1);

    // Update Firestore document
    updateDocument('libraries', 'offices', {
      category: 'offices',
      items: offices
    });

    return {
      success: true,
      message: 'Office deleted successfully'
    };
  } catch (error) {
    return {
      success: false,
      message: 'Error deleting office: ' + error.message
    };
  }
}

/**
 * Delete position
 */
function deletePosition(positionName) {
  try {
    const positions = getAllPositions();
    const index = positions.indexOf(positionName);

    if (index === -1) {
      return {
        success: false,
        message: 'Position not found'
      };
    }

    // Remove from array
    positions.splice(index, 1);

    // Update Firestore document
    updateDocument('libraries', 'positions', {
      category: 'positions',
      items: positions
    });

    return {
      success: true,
      message: 'Position deleted successfully'
    };
  } catch (error) {
    return {
      success: false,
      message: 'Error deleting position: ' + error.message
    };
  }
}

/**
 * Get signatory configuration from Firestore
 */
function getSignatoryConfig() {
  try {
    // Get the signatory document from libraries collection
    const signatoryDoc = getDocument('libraries', 'signatory');

    if (!signatoryDoc) {
      return {
        name: '',
        position: ''
      };
    }

    return {
      name: signatoryDoc.name || '',
      position: signatoryDoc.position || ''
    };
  } catch (error) {
    Logger.log('Error getting signatory config: ' + error.message);
    return {
      name: '',
      position: ''
    };
  }
}

/**
 * Set signatory configuration in Firestore
 * @param {Object} signatory - Object with name and position properties
 */
function setSignatoryConfig(signatory) {
  try {
    if (!signatory || !signatory.name || !signatory.position) {
      return {
        success: false,
        message: 'Both name and position are required'
      };
    }

    // Update or create signatory document
    upsertDocument('libraries', 'signatory', {
      category: 'signatory',
      name: signatory.name,
      position: signatory.position
    });

    return {
      success: true,
      message: 'Signatory configuration saved successfully'
    };
  } catch (error) {
    return {
      success: false,
      message: 'Error saving signatory config: ' + error.message
    };
  }
}

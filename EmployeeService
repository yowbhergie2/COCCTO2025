// EmployeeService.gs - Employee CRUD operations

/**
 * Get all employees
 * UPDATED: Now uses Firestore objects instead of array-based rows
 */
function getAllEmployees() {
  const data = getSheetData('Employees');

  // Data is already in object format from Firestore
  // No need to map - just return as-is
  return serializeDates(data);
}

/**
 * Get employee by ID
 * UPDATED: Now uses Firestore objects instead of array-based rows
 */
function getEmployeeById(employeeId) {
  const employee = getRowById('Employees', employeeId, 0);
  if (!employee) return null;

  // Data is already in object format from Firestore
  return serializeDates(employee);
}

/**
 * Search employee by ID or Name
 * @param {string} searchValue - Employee ID (number) or name (string)
 * @returns {Object|null} Employee object or null if not found
 */
function searchEmployeeByIdOrName(searchValue) {
  try {
    if (!searchValue) return null;

    const searchStr = searchValue.toString().trim().toLowerCase();

    // Try to search by ID first (if numeric)
    const numericId = parseInt(searchStr);
    if (!isNaN(numericId)) {
      const employee = getEmployeeById(numericId);
      if (employee) return employee;
    }

    // If not found by ID, search by name
    const data = getSheetData('Employees');

    for (let i = 0; i < data.length; i++) {
      const employee = data[i];
      const lastName = (employee.lastName || '').toString().toLowerCase();
      const firstName = (employee.firstName || '').toString().toLowerCase();
      const fullName = `${firstName} ${lastName}`.trim();
      const reverseName = `${lastName} ${firstName}`.trim();

      // Check if search matches firstName, lastName, or full name
      if (lastName.includes(searchStr) ||
          firstName.includes(searchStr) ||
          fullName.includes(searchStr) ||
          reverseName.includes(searchStr)) {

        return serializeDates(employee);
      }
    }

    // Not found
    return null;

  } catch (error) {
    Logger.log('Error in searchEmployeeByIdOrName: ' + error.toString());
    return null;
  }
}

/**
 * Create new employee
 * UPDATED: Now uses Firestore objects instead of arrays
 */
function createEmployee(employeeData) {
  try {
    const employeeId = getNextId('Employees', 'A');
    const currentEmail = getCurrentUserEmail();
    const currentDate = new Date();

    const employeeObject = {
      employeeId: String(employeeId),
      lastName: employeeData.lastName || '',
      firstName: employeeData.firstName || '',
      middleInitial: employeeData.middleInitial || '',
      suffix: employeeData.suffix || '',
      status: employeeData.status || 'Active',
      position: employeeData.position || '',
      office: employeeData.office || '',
      email: employeeData.email || ''
    };

    appendToSheet('Employees', employeeObject);

    return {
      success: true,
      employeeId: employeeId,
      message: 'Employee created successfully'
    };
  } catch (error) {
    return {
      success: false,
      message: 'Error creating employee: ' + error.message
    };
  }
}

/**
 * Update employee
 * UPDATED: Now uses Firestore objects instead of arrays
 */
function updateEmployee(employeeId, employeeData) {
  try {
    const existing = getEmployeeById(employeeId);
    if (!existing) {
      return {
        success: false,
        message: 'Employee not found'
      };
    }

    const updatedEmployee = {
      employeeId: String(employeeId),
      lastName: employeeData.lastName || existing.lastName,
      firstName: employeeData.firstName || existing.firstName,
      middleInitial: employeeData.middleInitial || existing.middleInitial,
      suffix: employeeData.suffix || existing.suffix,
      status: employeeData.status || existing.status,
      position: employeeData.position || existing.position,
      office: employeeData.office || existing.office,
      email: employeeData.email || existing.email
    };

    updateRowById('Employees', employeeId, updatedEmployee, 0);

    return {
      success: true,
      message: 'Employee updated successfully'
    };
  } catch (error) {
    return {
      success: false,
      message: 'Error updating employee: ' + error.message
    };
  }
}

/**
 * Delete employee (soft delete - set status to Inactive)
 */
function deleteEmployee(employeeId) {
  try {
    const existing = getEmployeeById(employeeId);
    if (!existing) {
      return {
        success: false,
        message: 'Employee not found'
      };
    }
    
    // Soft delete - set status to Inactive
    return updateEmployee(employeeId, { status: 'Inactive' });
  } catch (error) {
    return {
      success: false,
      message: 'Error deleting employee: ' + error.message
    };
  }
}

/**
 * Search employees by name
 */
function searchEmployees(searchTerm) {
  const allEmployees = getAllEmployees();
  const term = searchTerm.toLowerCase();
  
  return allEmployees.filter(emp => 
    emp.lastName.toLowerCase().includes(term) ||
    emp.firstName.toLowerCase().includes(term) ||
    (emp.lastName + ' ' + emp.firstName).toLowerCase().includes(term)
  );
}

/**
 * Get active employees only
 */
function getActiveEmployees() {
  const allEmployees = getAllEmployees();
  return allEmployees.filter(emp => emp.status === 'Active');
}

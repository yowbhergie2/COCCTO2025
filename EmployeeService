// EmployeeService.gs - Employee CRUD operations

/**
 * Get all employees
 */
function getAllEmployees() {
  const data = getSheetData('Employees');
  const employees = data.map(row => ({
    employeeId: row[0],
    lastName: row[1],
    firstName: row[2],
    middleInitial: row[3],
    suffix: row[4],
    status: row[5],
    position: row[6],
    office: row[7],
    createdDate: row[8],
    createdBy: row[9],
    modifiedDate: row[10],
    modifiedBy: row[11]
  }));
  
  return serializeDates(employees);
}

/**
 * Get employee by ID
 */
function getEmployeeById(employeeId) {
  const row = getRowById('Employees', employeeId, 0);
  if (!row) return null;

  return serializeDates({
    employeeId: row[0],
    lastName: row[1],
    firstName: row[2],
    middleInitial: row[3],
    suffix: row[4],
    status: row[5],
    position: row[6],
    office: row[7],
    createdDate: row[8],
    createdBy: row[9],
    modifiedDate: row[10],
    modifiedBy: row[11]
  });
}

/**
 * Search employee by ID or Name
 * @param {string} searchValue - Employee ID (number) or name (string)
 * @returns {Object|null} Employee object or null if not found
 */
function searchEmployeeByIdOrName(searchValue) {
  try {
    if (!searchValue) return null;

    const searchStr = searchValue.toString().trim().toLowerCase();

    // Try to search by ID first (if numeric)
    const numericId = parseInt(searchStr);
    if (!isNaN(numericId)) {
      const employee = getEmployeeById(numericId);
      if (employee) return employee;
    }

    // If not found by ID, search by name
    const data = getSheetData('Employees');

    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const employeeId = row[0];
      const lastName = (row[1] || '').toString().toLowerCase();
      const firstName = (row[2] || '').toString().toLowerCase();
      const fullName = `${firstName} ${lastName}`.trim();
      const reverseName = `${lastName} ${firstName}`.trim();

      // Check if search matches firstName, lastName, or full name
      if (lastName.includes(searchStr) ||
          firstName.includes(searchStr) ||
          fullName.includes(searchStr) ||
          reverseName.includes(searchStr)) {

        return serializeDates({
          employeeId: employeeId,
          lastName: row[1],
          firstName: row[2],
          middleInitial: row[3],
          suffix: row[4],
          status: row[5],
          position: row[6],
          office: row[7],
          createdDate: row[8],
          createdBy: row[9],
          modifiedDate: row[10],
          modifiedBy: row[11]
        });
      }
    }

    // Not found
    return null;

  } catch (error) {
    Logger.log('Error in searchEmployeeByIdOrName: ' + error.toString());
    return null;
  }
}

/**
 * Create new employee
 */
function createEmployee(employeeData) {
  try {
    const employeeId = getNextId('Employees', 'A');
    const currentEmail = getCurrentUserEmail();
    const currentDate = new Date();
    
    const rowData = [
      employeeId,
      employeeData.lastName || '',
      employeeData.firstName || '',
      employeeData.middleInitial || '',
      employeeData.suffix || '',
      employeeData.status || 'Active',
      employeeData.position || '',
      employeeData.office || '',
      currentDate,
      currentEmail,
      currentDate,
      currentEmail
    ];
    
    appendToSheet('Employees', rowData);
    
    return {
      success: true,
      employeeId: employeeId,
      message: 'Employee created successfully'
    };
  } catch (error) {
    return {
      success: false,
      message: 'Error creating employee: ' + error.message
    };
  }
}

/**
 * Update employee
 */
function updateEmployee(employeeId, employeeData) {
  try {
    const existing = getEmployeeById(employeeId);
    if (!existing) {
      return {
        success: false,
        message: 'Employee not found'
      };
    }
    
    const currentEmail = getCurrentUserEmail();
    const currentDate = new Date();
    
    const rowData = [
      employeeId,
      employeeData.lastName || existing.lastName,
      employeeData.firstName || existing.firstName,
      employeeData.middleInitial || existing.middleInitial,
      employeeData.suffix || existing.suffix,
      employeeData.status || existing.status,
      employeeData.position || existing.position,
      employeeData.office || existing.office,
      existing.createdDate,
      existing.createdBy,
      currentDate,
      currentEmail
    ];

    updateRowById('Employees', employeeId, rowData, 0);
    
    return {
      success: true,
      message: 'Employee updated successfully'
    };
  } catch (error) {
    return {
      success: false,
      message: 'Error updating employee: ' + error.message
    };
  }
}

/**
 * Delete employee (soft delete - set status to Inactive)
 */
function deleteEmployee(employeeId) {
  try {
    const existing = getEmployeeById(employeeId);
    if (!existing) {
      return {
        success: false,
        message: 'Employee not found'
      };
    }
    
    // Soft delete - set status to Inactive
    return updateEmployee(employeeId, { status: 'Inactive' });
  } catch (error) {
    return {
      success: false,
      message: 'Error deleting employee: ' + error.message
    };
  }
}

/**
 * Search employees by name
 */
function searchEmployees(searchTerm) {
  const allEmployees = getAllEmployees();
  const term = searchTerm.toLowerCase();
  
  return allEmployees.filter(emp => 
    emp.lastName.toLowerCase().includes(term) ||
    emp.firstName.toLowerCase().includes(term) ||
    (emp.lastName + ' ' + emp.firstName).toLowerCase().includes(term)
  );
}

/**
 * Get active employees only
 */
function getActiveEmployees() {
  const allEmployees = getAllEmployees();
  return allEmployees.filter(emp => emp.status === 'Active');
}

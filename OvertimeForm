<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background: transparent;
    }

    .entry-grid {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }

    .entry-grid th {
      background: #f8f9fa;
      padding: 0.75rem;
      text-align: left;
      font-size: 0.875rem;
      font-weight: 600;
      color: #1a1f36;
      border-bottom: 2px solid #e8ebed;
    }

    .entry-grid td {
      padding: 0.5rem;
      border-bottom: 1px solid #e8ebed;
    }

    .entry-grid input,
    .entry-grid select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #e8ebed;
      border-radius: 6px;
      font-size: 0.875rem;
    }

    .entry-grid input:focus,
    .entry-grid select:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .entry-grid input.error {
      border-color: #ef4444;
      background-color: #fee;
    }

    .entry-grid input.error:focus {
      border-color: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    .delete-row-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
    }

    .delete-row-btn:hover {
      background: #dc2626;
    }

    .coc-earned-cell {
      font-weight: 600;
      color: #4f46e5;
      text-align: center;
    }

    .day-type-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .day-type-weekday {
      background: #e0e7ff;
      color: #4338ca;
    }

    .day-type-weekend {
      background: #fef3c7;
      color: #92400e;
    }

    .day-type-holiday {
      background: #fce7f3;
      color: #9f1239;
    }

    .grand-total-box {
      background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      text-align: center;
    }

    .grand-total-label {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-bottom: 0.5rem;
    }

    .grand-total-value {
      font-size: 2rem;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div style="
    width: 95%;
    max-width: 1200px;
    padding: 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  ">
    <div style="margin-bottom: 2rem;">
      <h2 style="font-size: 1.5rem; font-weight: 700; color: #1a1f36; margin-bottom: 0.5rem;">
        Log Overtime (Add COC)
      </h2>
      <p style="color: #697386; font-size: 0.9375rem;">
        Record approved overtime work. Each entry will be saved as "Uncertified" until a certificate is generated.
      </p>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" style="margin-bottom: 1.5rem; display: none;"></div>

    <form id="overtimeForm" onsubmit="return handleFormSubmit(event)">
      <!-- Employee, Month, Year Selection -->
      <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
        <div>
          <label class="form-label">Employee <span style="color: #ef4444;">*</span></label>
          <select name="employeeId" id="employeeId" required class="form-input">
            <option value="">-- Select Employee --</option>
            <!-- Populated by server -->
          </select>
        </div>
        <div>
          <label class="form-label">Month <span style="color: #ef4444;">*</span></label>
          <select name="month" id="month" required class="form-input">
            <option value="">-- Select --</option>
            <option value="January">January</option>
            <option value="February">February</option>
            <option value="March">March</option>
            <option value="April">April</option>
            <option value="May">May</option>
            <option value="June">June</option>
            <option value="July">July</option>
            <option value="August">August</option>
            <option value="September">September</option>
            <option value="October">October</option>
            <option value="November">November</option>
            <option value="December">December</option>
          </select>
        </div>
        <div>
          <label class="form-label">Year <span style="color: #ef4444;">*</span></label>
          <select name="year" id="year" required class="form-input">
            <option value="">-- Select --</option>
            <!-- Years populated dynamically -->
          </select>
        </div>
      </div>

      <!-- Entry Grid -->
      <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3 style="font-size: 1.125rem; font-weight: 600; color: #1a1f36;">Overtime Entries</h3>
          <button type="button" class="btn btn-secondary" onclick="addRow()">
            <i class="fas fa-plus"></i> Add Day
          </button>
        </div>

        <div style="overflow-x: auto;">
          <table class="entry-grid" id="entryTable">
            <thead>
              <tr>
                <th style="width: 120px;">Date Worked</th>
                <th style="width: 100px;">Day Type</th>
                <th style="width: 100px;">AM In</th>
                <th style="width: 100px;">AM Out</th>
                <th style="width: 100px;">PM In</th>
                <th style="width: 100px;">PM Out</th>
                <th style="width: 100px;">COC Earned</th>
                <th style="width: 80px;">Action</th>
              </tr>
            </thead>
            <tbody id="entryTableBody">
              <!-- Rows added dynamically -->
            </tbody>
          </table>
        </div>

        <p style="color: #697386; font-size: 0.875rem; margin-top: 1rem;">
          <i class="fas fa-info-circle"></i> <strong>Note:</strong> COC Earned is auto-calculated based on policy rules.
          Weekdays: 5PM-7PM window (max 2 hrs × 1.0x). Weekends/Holidays: 8AM-12PM & 1PM-5PM windows × 1.5x rate.
        </p>
      </div>

      <!-- Grand Total -->
      <div class="grand-total-box">
        <div class="grand-total-label">Grand Total COC Earned</div>
        <div class="grand-total-value" id="grandTotal">0.0 hours</div>
      </div>

      <!-- Action Buttons -->
      <div style="display: flex; gap: 0.75rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #e8ebed;">
        <button type="button" onclick="hideOverlay()" class="btn btn-secondary">Cancel</button>
        <button type="submit" id="saveBtn" class="btn btn-primary">Save Overtime Batch</button>
      </div>
    </form>

    <!-- Error Modal -->
    <div id="errorModal" style="
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 200;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    ">
      <div style="
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        width: 90%;
        max-width: 450px;
        text-align: center;
      ">
        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;"></i>
        <h3 style="font-size: 1.25rem; font-weight: 600; color: #1a1f36; margin-bottom: 0.5rem;">Error</h3>
        <p id="errorModalMessage" style="color: #697386; font-size: 0.9375rem; margin-bottom: 1.5rem;"></p>
        <button type="button" onclick="hideErrorModal()" class="btn btn-primary" style="background: #ef4444; width: 100%; justify-content: center;">
          Okay
        </button>
      </div>
    </div>

    <!-- Duplicate Day Modal (Client-Side) -->
    <div id="duplicateDayModal" style="
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 200;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    ">
      <div style="
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        width: 90%;
        max-width: 500px;
        text-align: center;
      ">
        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f59e0b; margin-bottom: 1rem;"></i>
        <h3 style="font-size: 1.25rem; font-weight: 600; color: #1a1f36; margin-bottom: 0.5rem;">Duplicate Date Detected</h3>
        <p id="duplicateDayMessage" style="color: #697386; font-size: 0.9375rem; margin-bottom: 1.5rem;"></p>
        <div style="display: flex; gap: 0.75rem; justify-content: center;">
          <button type="button" onclick="cancelDuplicateDay()" class="btn btn-secondary">
            No, Cancel
          </button>
          <button type="button" onclick="confirmReplaceDuplicateDay()" class="btn btn-primary" style="background: #f59e0b;">
            Yes, Replace
          </button>
        </div>
      </div>
    </div>

    <!-- Validation Error Modal (Server-Side - Hard Stop) -->
    <div id="validationErrorModal" style="
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 200;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    ">
      <div style="
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        width: 90%;
        max-width: 500px;
        text-align: center;
      ">
        <i class="fas fa-ban" style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;"></i>
        <h3 style="font-size: 1.25rem; font-weight: 600; color: #1a1f36; margin-bottom: 0.5rem;">Validation Error</h3>
        <p id="validationErrorMessage" style="color: #697386; font-size: 0.9375rem; margin-bottom: 1.5rem;"></p>
        <p style="color: #697386; font-size: 0.875rem; margin-bottom: 1.5rem; font-style: italic;">
          To modify this date, please use the Edit or Delete buttons on the existing record.
        </p>
        <button type="button" onclick="hideValidationErrorModal()" class="btn btn-primary" style="background: #ef4444; width: 100%; justify-content: center;">
          Okay
        </button>
      </div>
    </div>
  </div>

  <script>
    let rowCounter = 0;
    let existingDatabaseDates = []; // Dates that already exist in database
    let duplicateContext = null; // Context for handling duplicate

    // Initialize form
    function initForm() {
      // Populate years (current year and 2 years back)
      const yearSelect = document.getElementById('year');
      const currentYear = new Date().getFullYear();
      for (let i = 0; i <= 2; i++) {
        const year = currentYear - i;
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (i === 0) option.selected = true;
        yearSelect.appendChild(option);
      }

      // Load employees
      google.script.run
        .withSuccessHandler(employees => {
          const empSelect = document.getElementById('employeeId');
          employees.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.id;
            option.textContent = emp.name;
            empSelect.appendChild(option);
          });
        })
        .withFailureHandler(err => {
          showErrorModal('Error loading employees: ' + err.message);
        })
        .getEmployeesForDropdown();

      // Add event listeners to reload existing dates when selection changes
      document.getElementById('employeeId').addEventListener('change', loadExistingDates);
      document.getElementById('month').addEventListener('change', () => {
        loadExistingDates();
        updateDateInputConstraints();
      });
      document.getElementById('year').addEventListener('change', () => {
        loadExistingDates();
        updateDateInputConstraints();
      });

      // Add first row
      addRow();
    }

    // Update date input constraints based on selected month/year
    function updateDateInputConstraints() {
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;

      if (!month || !year) {
        // Clear constraints if month/year not selected
        document.querySelectorAll('.date-input').forEach(input => {
          input.removeAttribute('min');
          input.removeAttribute('max');
        });
        return;
      }

      // Get the month index (0-11)
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
      const monthIndex = monthNames.indexOf(month);

      if (monthIndex === -1) return;

      // Calculate first and last day of the month
      const firstDay = new Date(parseInt(year), monthIndex, 1);
      const lastDay = new Date(parseInt(year), monthIndex + 1, 0);

      // Format as YYYY-MM-DD
      const minDate = formatDateForInput(firstDay);
      const maxDate = formatDateForInput(lastDay);

      // Apply to all date inputs
      document.querySelectorAll('.date-input').forEach(input => {
        input.setAttribute('min', minDate);
        input.setAttribute('max', maxDate);
      });
    }

    // Format date as YYYY-MM-DD for input
    function formatDateForInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Time validation helper functions
    function timeToMinutes(timeStr) {
      if (!timeStr) return null;
      const [hours, minutes] = timeStr.split(':').map(Number);
      return hours * 60 + minutes;
    }

    function validateTimeInput(input, minTime, maxTime, fieldName) {
      if (!input.value) {
        input.classList.remove('error');
        return true;
      }

      const minutes = timeToMinutes(input.value);
      const min = timeToMinutes(minTime);
      const max = timeToMinutes(maxTime);

      if (minutes < min || minutes > max) {
        input.classList.add('error');
        input.title = `${fieldName} must be between ${minTime} and ${maxTime}`;
        return false;
      }

      input.classList.remove('error');
      input.title = '';
      return true;
    }

    function validateRow(rowId) {
      const row = document.getElementById('row-' + rowId);
      if (!row) return true;

      const amInInput = row.querySelector('.am-in');
      const amOutInput = row.querySelector('.am-out');
      const pmInInput = row.querySelector('.pm-in');
      const pmOutInput = row.querySelector('.pm-out');

      let isValid = true;

      // AM In validation: 05:00 - 12:59
      if (amInInput.value) {
        if (!validateTimeInput(amInInput, '05:00', '12:59', 'AM In')) {
          isValid = false;
        }
      }

      // AM Out validation: 08:00 - 12:59
      if (amOutInput.value) {
        if (!validateTimeInput(amOutInput, '08:00', '12:59', 'AM Out')) {
          isValid = false;
        }
      }

      // PM In validation: 12:00 - 23:59
      if (pmInInput.value) {
        if (!validateTimeInput(pmInInput, '12:00', '23:59', 'PM In')) {
          isValid = false;
        }
      }

      // PM Out validation: 12:00 - 23:59
      if (pmOutInput.value) {
        if (!validateTimeInput(pmOutInput, '12:00', '23:59', 'PM Out')) {
          isValid = false;
        }
      }

      // Check pairs: AM In/Out must be complete
      if (amInInput.value && !amOutInput.value) {
        amOutInput.classList.add('error');
        amOutInput.title = 'AM Out is required when AM In is provided';
        isValid = false;
      } else if (!amInInput.value && amOutInput.value) {
        amInInput.classList.add('error');
        amInInput.title = 'AM In is required when AM Out is provided';
        isValid = false;
      } else if (amInInput.value && amOutInput.value) {
        // Both have values, clear pair errors (but keep time range/comparison errors)
        // Don't clear here - let comparison validation handle it
      } else {
        // Both are empty, clear any pair-related errors
        if (amInInput.title.includes('required')) {
          amInInput.classList.remove('error');
          amInInput.title = '';
        }
        if (amOutInput.title.includes('required')) {
          amOutInput.classList.remove('error');
          amOutInput.title = '';
        }
      }

      // Check pairs: PM In/Out must be complete
      if (pmInInput.value && !pmOutInput.value) {
        pmOutInput.classList.add('error');
        pmOutInput.title = 'PM Out is required when PM In is provided';
        isValid = false;
      } else if (!pmInInput.value && pmOutInput.value) {
        pmInInput.classList.add('error');
        pmInInput.title = 'PM In is required when PM Out is provided';
        isValid = false;
      } else if (pmInInput.value && pmOutInput.value) {
        // Both have values, clear pair errors
        // Don't clear here - let comparison validation handle it
      } else {
        // Both are empty, clear any pair-related errors
        if (pmInInput.title.includes('required')) {
          pmInInput.classList.remove('error');
          pmInInput.title = '';
        }
        if (pmOutInput.title.includes('required')) {
          pmOutInput.classList.remove('error');
          pmOutInput.title = '';
        }
      }

      // AM Out must be later than AM In
      if (amInInput.value && amOutInput.value) {
        const amInMinutes = timeToMinutes(amInInput.value);
        const amOutMinutes = timeToMinutes(amOutInput.value);
        if (amOutMinutes <= amInMinutes) {
          amOutInput.classList.add('error');
          amOutInput.title = 'AM Out must be later than AM In';
          isValid = false;
        } else {
          // Clear comparison error if it was set
          if (amOutInput.title.includes('later than AM In')) {
            amOutInput.classList.remove('error');
            amOutInput.title = '';
          }
        }
      }

      // PM Out must be later than PM In
      if (pmInInput.value && pmOutInput.value) {
        const pmInMinutes = timeToMinutes(pmInInput.value);
        const pmOutMinutes = timeToMinutes(pmOutInput.value);
        if (pmOutMinutes <= pmInMinutes) {
          pmOutInput.classList.add('error');
          pmOutInput.title = 'PM Out must be later than PM In';
          isValid = false;
        } else {
          // Clear comparison error if it was set
          if (pmOutInput.title.includes('later than PM In')) {
            pmOutInput.classList.remove('error');
            pmOutInput.title = '';
          }
        }
      }

      // PM In must be later than AM Out (noon break)
      if (amOutInput.value && pmInInput.value) {
        const amOutMinutes = timeToMinutes(amOutInput.value);
        const pmInMinutes = timeToMinutes(pmInInput.value);
        if (pmInMinutes <= amOutMinutes) {
          pmInInput.classList.add('error');
          pmInInput.title = 'PM In must be later than AM Out (noon break required)';
          isValid = false;
        } else {
          // Clear noon break error if it was set
          if (pmInInput.title.includes('noon break')) {
            pmInInput.classList.remove('error');
            pmInInput.title = '';
          }
        }
      } else {
        // Clear noon break error if one of the inputs is empty
        if (pmInInput.title.includes('noon break')) {
          pmInInput.classList.remove('error');
          pmInInput.title = '';
        }
      }

      return isValid;
    }

    // Check for duplicate dates in current form (client-side)
    function checkClientSideDuplicate(dateValue, currentRowId) {
      if (!dateValue) return null;

      const rows = document.querySelectorAll('#entryTableBody tr');
      for (const row of rows) {
        const rowIdMatch = row.id.match(/row-(\d+)/);
        if (rowIdMatch) {
          const rowId = parseInt(rowIdMatch[1]);
          if (rowId !== currentRowId) {
            const dateInput = row.querySelector('.date-input');
            if (dateInput && dateInput.value === dateValue) {
              return rowId; // Found duplicate
            }
          }
        }
      }
      return null;
    }

    // Check for duplicate date in database (server-side)
    function checkServerSideDuplicate(dateValue) {
      if (!dateValue || existingDatabaseDates.length === 0) return false;
      return existingDatabaseDates.includes(dateValue);
    }

    // Handle date input change with duplicate detection
    function handleDateChange(rowId) {
      const row = document.getElementById('row-' + rowId);
      if (!row) return;

      const dateInput = row.querySelector('.date-input');
      const dateValue = dateInput.value;

      if (!dateValue) {
        dateInput.classList.remove('error');
        updateRow(rowId);
        return;
      }

      // First check server-side duplicate (hard stop)
      if (checkServerSideDuplicate(dateValue)) {
        const month = document.getElementById('month').value;
        const year = document.getElementById('year').value;
        const dateObj = new Date(dateValue);
        const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

        showValidationErrorModal(
          `${formattedDate} already has a COC record in the database. ` +
          `This date cannot be added again.`
        );

        // Clear the invalid date
        dateInput.value = '';
        dateInput.classList.add('error');
        return;
      }

      // Then check client-side duplicate (soft warning)
      const duplicateRowId = checkClientSideDuplicate(dateValue, rowId);
      if (duplicateRowId !== null) {
        const dateObj = new Date(dateValue);
        const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

        duplicateContext = {
          currentRowId: rowId,
          duplicateRowId: duplicateRowId,
          dateValue: dateValue
        };

        showDuplicateDayModal(
          `You already have an entry for ${formattedDate} in this form. ` +
          `Do you want to replace the existing entry?`
        );
        return;
      }

      // No duplicates, proceed normally
      dateInput.classList.remove('error');
      updateRow(rowId);
    }

    // Show duplicate day modal (client-side)
    function showDuplicateDayModal(message) {
      const modal = document.getElementById('duplicateDayModal');
      const messageEl = document.getElementById('duplicateDayMessage');
      if (modal && messageEl) {
        messageEl.textContent = message;
        modal.style.display = 'flex';
      }
    }

    // Cancel duplicate day replacement
    function cancelDuplicateDay() {
      if (duplicateContext) {
        const row = document.getElementById('row-' + duplicateContext.currentRowId);
        if (row) {
          const dateInput = row.querySelector('.date-input');
          if (dateInput) {
            dateInput.value = ''; // Clear the date
          }
        }
      }
      duplicateContext = null;
      document.getElementById('duplicateDayModal').style.display = 'none';
    }

    // Confirm replace duplicate day
    function confirmReplaceDuplicateDay() {
      if (duplicateContext) {
        // Delete the old row
        deleteRow(duplicateContext.duplicateRowId);

        // Keep the current row with the date
        const currentRow = document.getElementById('row-' + duplicateContext.currentRowId);
        if (currentRow) {
          updateRow(duplicateContext.currentRowId);
        }
      }
      duplicateContext = null;
      document.getElementById('duplicateDayModal').style.display = 'none';
    }

    // Show validation error modal (server-side - hard stop)
    function showValidationErrorModal(message) {
      const modal = document.getElementById('validationErrorModal');
      const messageEl = document.getElementById('validationErrorMessage');
      if (modal && messageEl) {
        messageEl.textContent = message;
        modal.style.display = 'flex';
      }
    }

    // Hide validation error modal
    function hideValidationErrorModal() {
      document.getElementById('validationErrorModal').style.display = 'none';
    }

    // Load existing dates from database
    function loadExistingDates() {
      const employeeId = document.getElementById('employeeId').value;
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;

      if (!employeeId || !month || !year) {
        existingDatabaseDates = [];
        return;
      }

      // Call server to get existing dates for this employee/month/year
      google.script.run
        .withSuccessHandler(dates => {
          existingDatabaseDates = dates || [];
          console.log('Loaded existing dates:', existingDatabaseDates);
        })
        .withFailureHandler(err => {
          console.error('Error loading existing dates:', err);
          existingDatabaseDates = [];
        })
        .getExistingOvertimeDates(parseInt(employeeId), month, parseInt(year));
    }

    // Add a new entry row
    function addRow() {
      rowCounter++;
      const tbody = document.getElementById('entryTableBody');
      const row = document.createElement('tr');
      row.id = 'row-' + rowCounter;

      row.innerHTML = `
        <td>
          <input type="date" class="date-input" onchange="handleDateChange(${rowCounter})" required>
        </td>
        <td>
          <div class="day-type-badge day-type-weekday" id="dayType-${rowCounter}">Weekday</div>
        </td>
        <td>
          <input type="time" class="am-in" oninput="validateAndUpdateRow(${rowCounter})">
        </td>
        <td>
          <input type="time" class="am-out" oninput="validateAndUpdateRow(${rowCounter})">
        </td>
        <td>
          <input type="time" class="pm-in" oninput="validateAndUpdateRow(${rowCounter})">
        </td>
        <td>
          <input type="time" class="pm-out" oninput="validateAndUpdateRow(${rowCounter})">
        </td>
        <td class="coc-earned-cell" id="cocEarned-${rowCounter}">0.0</td>
        <td>
          <button type="button" class="delete-row-btn" onclick="deleteRow(${rowCounter})">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;

      tbody.appendChild(row);

      // Apply date constraints to the new row
      updateDateInputConstraints();
    }

    // Validate and update row (called on time input changes)
    function validateAndUpdateRow(rowId) {
      validateRow(rowId);
      updateRow(rowId);
    }

    // Update row calculations
    function updateRow(rowId) {
      const row = document.getElementById('row-' + rowId);
      if (!row) return;

      const dateInput = row.querySelector('.date-input');
      const dayTypeDiv = document.getElementById('dayType-' + rowId);
      const cocEarnedDiv = document.getElementById('cocEarned-' + rowId);

      // Determine day type
      let dayType = 'Weekday';
      if (dateInput.value) {
        const date = new Date(dateInput.value);
        const dayOfWeek = date.getDay();

        // For now, simple weekend detection (Saturday = 6, Sunday = 0)
        // TODO: Check holidays via server call
        if (dayOfWeek === 0 || dayOfWeek === 6) {
          dayType = 'Weekend';
        }

        dayTypeDiv.textContent = dayType;
        dayTypeDiv.className = 'day-type-badge day-type-' + dayType.toLowerCase();
      }

      // Get time inputs
      const amIn = row.querySelector('.am-in').value;
      const amOut = row.querySelector('.am-out').value;
      const pmIn = row.querySelector('.pm-in').value;
      const pmOut = row.querySelector('.pm-out').value;

      // Calculate COC Earned
      let cocEarned = 0;
      if (dateInput.value && (amIn || amOut || pmIn || pmOut)) {
        cocEarned = calculateCOC(dayType, amIn, amOut, pmIn, pmOut);
      }

      cocEarnedDiv.textContent = cocEarned.toFixed(1);
      updateGrandTotal();
    }

    // Calculate COC based on day type and time inputs
    function calculateCOC(dayType, amIn, amOut, pmIn, pmOut) {
      let totalCOC = 0;

      if (dayType === 'Weekday') {
        // Weekday: Only PM session counts (5PM-7PM window, 1.0x rate, max 2 hours)
        if (pmIn && pmOut) {
          const pmInMinutes = timeToMinutes(pmIn);
          const pmOutMinutes = timeToMinutes(pmOut);

          // Define 5PM-7PM window (17:00-19:00)
          const windowStart = 17 * 60; // 5PM = 1020 minutes
          const windowEnd = 19 * 60;   // 7PM = 1140 minutes

          // Clamp times to the 5PM-7PM window
          const effectiveIn = Math.max(pmInMinutes, windowStart);
          const effectiveOut = Math.min(pmOutMinutes, windowEnd);

          if (effectiveOut > effectiveIn) {
            const hoursWorked = (effectiveOut - effectiveIn) / 60;
            totalCOC = Math.min(hoursWorked, 2); // Max 2 hours
          }
        }
      } else {
        // Weekend/Holiday: Both AM and PM sessions count (1.5x rate)
        // AM window: 8AM-12PM (08:00-12:00)
        if (amIn && amOut) {
          const amInMinutes = timeToMinutes(amIn);
          const amOutMinutes = timeToMinutes(amOut);

          const amWindowStart = 8 * 60;  // 8AM = 480 minutes
          const amWindowEnd = 12 * 60;   // 12PM = 720 minutes

          const effectiveAmIn = Math.max(amInMinutes, amWindowStart);
          const effectiveAmOut = Math.min(amOutMinutes, amWindowEnd);

          if (effectiveAmOut > effectiveAmIn) {
            const amHoursWorked = (effectiveAmOut - effectiveAmIn) / 60;
            totalCOC += amHoursWorked * 1.5; // 1.5x rate
          }
        }

        // PM window: 1PM-5PM (13:00-17:00)
        if (pmIn && pmOut) {
          const pmInMinutes = timeToMinutes(pmIn);
          const pmOutMinutes = timeToMinutes(pmOut);

          const pmWindowStart = 13 * 60; // 1PM = 780 minutes
          const pmWindowEnd = 17 * 60;   // 5PM = 1020 minutes

          const effectivePmIn = Math.max(pmInMinutes, pmWindowStart);
          const effectivePmOut = Math.min(pmOutMinutes, pmWindowEnd);

          if (effectivePmOut > effectivePmIn) {
            const pmHoursWorked = (effectivePmOut - effectivePmIn) / 60;
            totalCOC += pmHoursWorked * 1.5; // 1.5x rate
          }
        }
      }

      return totalCOC;
    }

    // Delete a row
    function deleteRow(rowId) {
      const row = document.getElementById('row-' + rowId);
      if (row) {
        row.remove();
        updateGrandTotal();
      }

      // Ensure at least one row exists
      const tbody = document.getElementById('entryTableBody');
      if (tbody.children.length === 0) {
        addRow();
      }
    }

    // Update grand total
    function updateGrandTotal() {
      const rows = document.querySelectorAll('#entryTableBody tr');
      let grandTotal = 0;

      rows.forEach(row => {
        const rowIdMatch = row.id.match(/row-(\d+)/);
        if (rowIdMatch) {
          const rowId = parseInt(rowIdMatch[1]);
          const cocEarnedDiv = document.getElementById('cocEarned-' + rowId);
          if (cocEarnedDiv) {
            const value = parseFloat(cocEarnedDiv.textContent) || 0;
            grandTotal += value;
          }
        }
      });

      const grandTotalDiv = document.getElementById('grandTotal');
      grandTotalDiv.textContent = grandTotal.toFixed(1) + ' hours';
    }

    // Handle form submission
    function handleFormSubmit(e) {
      e.preventDefault();

      const employeeId = parseInt(document.getElementById('employeeId').value);
      const month = document.getElementById('month').value;
      const year = parseInt(document.getElementById('year').value);

      if (!employeeId || !month || !year) {
        showErrorModal('Please select Employee, Month, and Year');
        return false;
      }

      // Validate all rows first
      const rows = document.querySelectorAll('#entryTableBody tr');
      let allRowsValid = true;
      const rowIds = [];

      rows.forEach(row => {
        const rowIdMatch = row.id.match(/row-(\d+)/);
        if (rowIdMatch) {
          const rowId = parseInt(rowIdMatch[1]);
          rowIds.push(rowId);
          if (!validateRow(rowId)) {
            allRowsValid = false;
          }
        }
      });

      if (!allRowsValid) {
        showErrorModal('Please fix the validation errors (red boxes) before submitting');
        return false;
      }

      // Collect entries
      const entries = [];

      rows.forEach(row => {
        const dateInput = row.querySelector('.date-input');
        const amIn = row.querySelector('.am-in').value;
        const amOut = row.querySelector('.am-out').value;
        const pmIn = row.querySelector('.pm-in').value;
        const pmOut = row.querySelector('.pm-out').value;

        if (dateInput && dateInput.value) {
          entries.push({
            dateWorked: dateInput.value,
            amIn: formatTimeFor12Hour(amIn),
            amOut: formatTimeFor12Hour(amOut),
            pmIn: formatTimeFor12Hour(pmIn),
            pmOut: formatTimeFor12Hour(pmOut)
          });
        }
      });

      if (entries.length === 0) {
        showErrorModal('Please add at least one overtime entry with a date');
        return false;
      }

      // Prepare batch data
      const batchData = {
        employeeId: employeeId,
        month: month,
        year: year,
        entries: entries
      };

      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      // Submit to server
      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            showMessage(result.message, 'success');
            setTimeout(() => {
              hideOverlay(true);
            }, 2000);
          } else {
            showErrorModal(result.message);
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Overtime Batch';
          }
        })
        .withFailureHandler(err => {
          showErrorModal('Error: ' + err.message);
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Overtime Batch';
        })
        .saveOvertimeBatch(batchData);
    }

    // Format time from 24-hour to 12-hour
    function formatTimeFor12Hour(time24) {
      if (!time24 || time24.trim() === '') return '';

      try {
        const [hours, minutes] = time24.split(':');
        let h = parseInt(hours, 10);
        const m = minutes;
        const period = h >= 12 ? 'PM' : 'AM';

        if (h === 0) h = 12;
        else if (h > 12) h -= 12;

        return `${h.toString().padStart(2, '0')}:${m} ${period}`;
      } catch (error) {
        return '';
      }
    }

    function showMessage(message, type) {
      const colors = {
        success: { bg: '#e0e7ff', border: '#4f46e5', text: '#4338ca' },
        error: { bg: '#fee', border: '#ef4444', text: '#ef4444' },
        info: { bg: '#e6f3ff', border: '#3b82f6', text: '#3b82f6' }
      };
      const color = colors[type];

      const container = document.getElementById('messageContainer');
      if (!container) return;

      container.style.cssText = `
        background: ${color.bg};
        border: 1px solid ${color.border};
        color: ${color.text};
        padding: 1rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.9375rem;
        margin-bottom: 1.5rem;
        display: block;
      `;
      container.textContent = message;
      container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function showErrorModal(message) {
      const modal = document.getElementById('errorModal');
      const modalMessage = document.getElementById('errorModalMessage');

      if (!modal || !modalMessage) {
        alert(message);
        return;
      }

      modalMessage.textContent = message;
      modal.style.display = 'flex';
    }

    function hideErrorModal() {
      const modal = document.getElementById('errorModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Initialize on load
    initForm();
  </script>
</body>
</html>

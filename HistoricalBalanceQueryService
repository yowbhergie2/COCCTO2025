// HistoricalBalanceQueryService.gs - Query historical balance records

/**
 * Get all historical balance records for an employee
 * @param {number} employeeId - The employee ID
 * @returns {Array} Array of historical balance records
 * UPDATED: Now uses Firestore instead of Sheets
 */
function getEmployeeHistoricalBalances(employeeId) {
  try {
    // Get all CreditBatches documents from Firestore
    const data = getSheetData_V2('CreditBatches');

    if (!data || data.length === 0) {
      return [];
    }

    const records = [];

    // Get current date for status calculation
    const now = new Date();
    now.setHours(0, 0, 0, 0);

    // Process each document
    for (let i = 0; i < data.length; i++) {
      const doc = data[i];

      // Check if this is a historical balance entry for this employee
      if (doc.employeeId == employeeId &&
          doc.notes &&
          doc.notes.toString().includes('Historical data migration')) {

        // Calculate COC Used based on Original - Remaining
        const cocEarned = parseFloat(doc.originalHours) || 0;
        const remaining = parseFloat(doc.remainingHours) || 0;
        const cocUsed = cocEarned - remaining;

        // Calculate current status (check if expired)
        let currentStatus = doc.status;
        const validUntil = doc.validUntil ? new Date(doc.validUntil) : null;

        if (currentStatus === 'Active' && validUntil && validUntil < now) {
          currentStatus = 'Expired';
        }

        records.push({
          batchId: doc.batchId,
          month: doc.earnedMonth,
          year: doc.earnedYear,
          cocEarned: cocEarned.toFixed(1),
          cocUsed: cocUsed.toFixed(1),
          remaining: remaining.toFixed(1),
          dateOfIssuance: formatDate(doc.dateOfIssuance),
          validUntil: formatDate(doc.validUntil),
          status: currentStatus
        });
      }
    }
    
    // Sort by year and month (most recent first)
    records.sort((a, b) => {
      if (a.year !== b.year) {
        return b.year - a.year;
      }
      const monthOrder = {
        'January': 1, 'February': 2, 'March': 3, 'April': 4,
        'May': 5, 'June': 6, 'July': 7, 'August': 8,
        'September': 9, 'October': 10, 'November': 11, 'December': 12
      };
      return monthOrder[b.month] - monthOrder[a.month];
    });
    
    return records;
    
  } catch (error) {
    Logger.log('Error in getEmployeeHistoricalBalances: ' + error.toString());
    return [];
  }
}

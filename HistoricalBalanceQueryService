// HistoricalBalanceQueryService.gs - Query historical balance records

/**
 * Get all historical balance records for an employee
 * @param {number} employeeId - The employee ID
 * @returns {Array} Array of historical balance records
 * UPDATED: Now uses Firestore instead of Sheets
 * Shows all CreditBatches for the employee (not just historical migration ones)
 */
function getEmployeeHistoricalBalances(employeeId) {
  try {
    Logger.log('=== getEmployeeHistoricalBalances START ===');
    Logger.log('getEmployeeHistoricalBalances called for employeeId: ' + employeeId + ' (type: ' + typeof employeeId + ')');

    // --- PABILIS-FIX: Use queryDocuments ---
    // Imbis na i-load lahat, kunin lang ang batches para sa employeeId na ito.
    // Ensure employeeId is a number to match Firestore data type
    const parsedId = parseInt(employeeId);
    Logger.log('Parsed employeeId: ' + parsedId + ' (type: ' + typeof parsedId + ')');

    const data = queryDocuments('creditBatches', 'employeeId', '==', parsedId);
    // --- END FIX ---

    Logger.log('Query returned ' + (data ? data.length : 0) + ' batches');

    if (data && data.length > 0) {
      Logger.log('First batch data: ' + JSON.stringify(data[0]));
    }

    if (!data || data.length === 0) {
      Logger.log('No batches found for employeeId: ' + employeeId);
      Logger.log('=== getEmployeeHistoricalBalances END (no results) ===');
      return [];
    }

    const records = [];

    // Get current date for status calculation
    const now = new Date();
    now.setHours(0, 0, 0, 0);

    // Process each document
    for (let i = 0; i < data.length; i++) {
      const doc = data[i];

      // --- PABILIS-FIX: Tinanggal ang "if (doc.employeeId == employeeId)" ---
      // Hindi na ito kailangan dahil 'yung query na ang gumawa nito.
      
      // Check kung valid 'yung data (may originalHours)
      if (doc.originalHours !== undefined && typeof doc.originalHours === 'number') {
        Logger.log('Processing batch ' + doc.batchId + ': originalHours=' + doc.originalHours + ', remainingHours=' + doc.remainingHours);

        // Calculate COC Used based on Original - Remaining
        const cocEarned = parseFloat(doc.originalHours) || 0;
        const remaining = parseFloat(doc.remainingHours) || 0;
        const cocUsed = cocEarned - remaining;

        // Calculate current status (check if expired)
        let currentStatus = doc.status;
        const validUntil = doc.validUntil ? new Date(doc.validUntil) : null;

        if (currentStatus === 'Active' && validUntil && validUntil < now) {
          currentStatus = 'Expired';
        }

        // Handle month/year - some batches have earnedMonth/earnedYear, others have earnedDate
        let month, year;
        if (doc.earnedMonth && doc.earnedYear) {
          month = doc.earnedMonth;
          year = doc.earnedYear;
        } else if (doc.earnedDate) {
          const earnedDate = new Date(doc.earnedDate);
          const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                             'July', 'August', 'September', 'October', 'November', 'December'];
          month = monthNames[earnedDate.getMonth()];
          year = earnedDate.getFullYear();
        } else {
          // Kung walang month/year, 'wag isama sa list
          continue; 
        }

        // Handle dateOfIssuance - use earnedDate if dateOfIssuance is not present
        const dateOfIssuance = doc.dateOfIssuance || doc.earnedDate;

        records.push({
          batchId: doc.batchId,
          month: month,
          year: year,
          cocEarned: cocEarned.toFixed(1),
          cocUsed: cocUsed.toFixed(1),
          remaining: remaining.toFixed(1),
          dateOfIssuance: formatDate(dateOfIssuance),
          validUntil: formatDate(validUntil),
          status: currentStatus
        });
      }
    }
    
    // Sort by year and month (most recent first)
    records.sort((a, b) => {
      if (a.year !== b.year) {
        return b.year - a.year;
      }
      const monthOrder = {
        'January': 1, 'February': 2, 'March': 3, 'April': 4,
        'May': 5, 'June': 6, 'July': 7, 'August': 8,
        'September': 9, 'October': 10, 'November': 11, 'December': 12
      };
      return monthOrder[b.month] - monthOrder[a.month];
    });

    Logger.log('Returning ' + records.length + ' records for employeeId ' + employeeId);
    return records;
    
  } catch (error) {
    Logger.log('Error in getEmployeeHistoricalBalances: ' + error.toString());
    return [];
  }
}

<script>
  // Tab Management
  function showConfigTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.config-tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');

    // Update sections
    document.querySelectorAll('.config-section').forEach(section => section.classList.remove('active'));
    document.getElementById('section-' + tabName).classList.add('active');

    // Load data for the tab
    if (tabName === 'basic') {
      refreshMasterData();
    } else if (tabName === 'holidays') {
      refreshHolidays();
    } else if (tabName === 'weekend') {
      refreshWeekendConfig();
    }
  }

  // ========== BASIC DATA (Offices & Positions) ==========

  /**
   * Refreshes both master data lists (Offices and Positions)
   */
  function refreshMasterData() {
    // Load Offices
    google.script.run
      .withSuccessHandler(offices => {
        const list = document.getElementById('officesList');
        if (!list) return;
        list.innerHTML = '';
        if (offices.length === 0) {
          list.innerHTML = '<p style="text-align: center; color: #697386;">No offices found</p>';
          return;
        }
        offices.sort().forEach(office => {
          list.appendChild(createMasterDataItem(office, 'office'));
        });
      })
      .withFailureHandler(err => {
        showAlert('Error loading offices: ' + err.message, 'error');
      })
      .getAllOffices();

    // Load Positions
    google.script.run
      .withSuccessHandler(positions => {
        const list = document.getElementById('positionsList');
        if (!list) return;
        list.innerHTML = '';
        if (positions.length === 0) {
          list.innerHTML = '<p style="text-align: center; color: #697386;">No positions found</p>';
          return;
        }
        positions.sort().forEach(position => {
          list.appendChild(createMasterDataItem(position, 'position'));
        });
      })
      .withFailureHandler(err => {
        showAlert('Error loading positions: ' + err.message, 'error');
      })
      .getAllPositions();
  }

  /**
   * Creates a list item for master data
   */
  function createMasterDataItem(name, type) {
    const div = document.createElement('div');
    div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0.5rem; border-bottom: 1px solid #f0f2f5;';

    const text = document.createElement('span');
    text.textContent = name;
    text.style.color = '#1a1f36';

    const buttons = document.createElement('div');
    buttons.style.display = 'flex';
    buttons.style.gap = '0.5rem';

    buttons.innerHTML = `
      <button onclick="editMasterDataItem('${name}', '${type}')" title="Edit"
              style="color: #3b82f6; cursor: pointer; background: none; border: none; font-size: 0.875rem;">
        <i class="fas fa-pencil-alt"></i>
      </button>
      <button onclick="deleteMasterDataItem('${name}', '${type}')" title="Delete"
              style="color: #ef4444; cursor: pointer; background: none; border: none; font-size: 0.875rem;">
        <i class="fas fa-trash-alt"></i>
      </button>
    `;

    div.appendChild(text);
    div.appendChild(buttons);
    return div;
  }

  /**
   * Prompts user to add a new master data item
   */
  function addMasterDataItem(type) {
    const name = prompt(`Enter new ${type} name:`);
    if (name && name.trim() !== '') {
      const serverFunc = (type === 'office') ? 'addOffice' : 'addPosition';
      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            showAlert(result.message, 'success');
            refreshMasterData();
          } else {
            showAlert(result.message, 'error');
          }
        })
        .withFailureHandler(err => showAlert('Error: ' + err.message, 'error'))
        [serverFunc](name.trim());
    }
  }

  /**
   * Prompts user to edit a master data item
   */
  function editMasterDataItem(oldName, type) {
    const newName = prompt(`Edit ${type} name:`, oldName);
    if (newName && newName.trim() !== '' && newName !== oldName) {
      const serverFunc = (type === 'office') ? 'updateOffice' : 'updatePosition';
      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            showAlert(result.message, 'success');
            refreshMasterData();
          } else {
            showAlert(result.message, 'error');
          }
        })
        .withFailureHandler(err => showAlert('Error: ' + err.message, 'error'))
        [serverFunc](oldName, newName.trim());
    }
  }

  /**
   * Confirms and deletes a master data item
   */
  function deleteMasterDataItem(name, type) {
    const confirmed = confirm(`Are you sure you want to delete "${name}"?`);
    if (confirmed) {
      const serverFunc = (type === 'office') ? 'deleteOffice' : 'deletePosition';
      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            showAlert(result.message, 'success');
            refreshMasterData();
          } else {
            showAlert(result.message, 'error');
          }
        })
        .withFailureHandler(err => showAlert('Error: ' + err.message, 'error'))
        [serverFunc](name);
    }
  }

  // ========== HOLIDAYS ==========

  /**
   * Refresh holidays list
   */
  function refreshHolidays() {
    google.script.run
      .withSuccessHandler(holidays => {
        const list = document.getElementById('holidaysList');
        if (!list) return;
        list.innerHTML = '';

        if (holidays.length === 0) {
          list.innerHTML = '<p style="text-align: center; color: #697386;">No holidays found</p>';
          return;
        }

        // Sort by date (most recent first)
        holidays.sort((a, b) => new Date(b.holidayDate) - new Date(a.holidayDate));

        // Create table
        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr>';
        html += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e8ebed; font-weight: 600;">Holiday Name</th>';
        html += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e8ebed; font-weight: 600;">Date</th>';
        html += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e8ebed; font-weight: 600;">Year</th>';
        html += '<th style="text-align: center; padding: 0.75rem; border-bottom: 2px solid #e8ebed; font-weight: 600;">Actions</th>';
        html += '</tr></thead><tbody>';

        holidays.forEach(holiday => {
          html += '<tr>';
          html += `<td style="padding: 0.75rem; border-bottom: 1px solid #f0f2f5;">${holiday.holidayName}</td>`;
          html += `<td style="padding: 0.75rem; border-bottom: 1px solid #f0f2f5;">${holiday.holidayDate}</td>`;
          html += `<td style="padding: 0.75rem; border-bottom: 1px solid #f0f2f5;">${holiday.year}</td>`;
          html += `<td style="padding: 0.75rem; border-bottom: 1px solid #f0f2f5; text-align: center;">`;
          html += `<button onclick="editHoliday(${holiday.holidayId})" style="color: #3b82f6; cursor: pointer; background: none; border: none; font-size: 0.875rem; margin-right: 0.5rem;"><i class="fas fa-pencil-alt"></i></button>`;
          html += `<button onclick="deleteHoliday(${holiday.holidayId})" style="color: #ef4444; cursor: pointer; background: none; border: none; font-size: 0.875rem;"><i class="fas fa-trash-alt"></i></button>`;
          html += `</td>`;
          html += '</tr>';
        });

        html += '</tbody></table>';
        list.innerHTML = html;
      })
      .withFailureHandler(err => {
        showAlert('Error loading holidays: ' + err.message, 'error');
      })
      .getAllHolidays();
  }

  /**
   * Add new holiday
   */
  function addHoliday() {
    showOverlay('HolidayForm', {});
  }

  /**
   * Edit holiday
   */
  function editHoliday(holidayId) {
    showOverlay('HolidayForm', { holidayId: holidayId });
  }

  /**
   * Delete holiday
   */
  function deleteHoliday(holidayId) {
    if (confirm('Are you sure you want to delete this holiday?')) {
      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            showAlert(result.message, 'success');
            refreshHolidays();
          } else {
            showAlert(result.message, 'error');
          }
        })
        .withFailureHandler(err => {
          showAlert('Error: ' + err.message, 'error');
        })
        .deleteHoliday(holidayId);
    }
  }

  // ========== WEEKEND CONFIGURATION ==========

  /**
   * Refresh weekend configuration
   */
  function refreshWeekendConfig() {
    google.script.run
      .withSuccessHandler(weekendDays => {
        // Update checkboxes
        document.querySelectorAll('.weekend-checkbox').forEach(cb => {
          cb.checked = weekendDays.includes(parseInt(cb.value));
        });

        // Update current display
        google.script.run
          .withSuccessHandler(dayNames => {
            const display = document.getElementById('currentWeekendDays');
            if (display) {
              display.textContent = dayNames.join(', ');
            }
          })
          .getWeekendDayNames();
      })
      .withFailureHandler(err => {
        showAlert('Error loading weekend config: ' + err.message, 'error');
      })
      .getWeekendDays();
  }

  /**
   * Save weekend configuration
   */
  function saveWeekendConfig() {
    const selectedDays = [];
    document.querySelectorAll('.weekend-checkbox:checked').forEach(cb => {
      selectedDays.push(parseInt(cb.value));
    });

    if (selectedDays.length === 0) {
      showAlert('Please select at least one weekend day', 'error');
      return;
    }

    google.script.run
      .withSuccessHandler(result => {
        if (result.success) {
          showAlert(result.message, 'success');
          refreshWeekendConfig();
        } else {
          showAlert(result.message, 'error');
        }
      })
      .withFailureHandler(err => {
        showAlert('Error: ' + err.message, 'error');
      })
      .setWeekendDays(selectedDays);
  }

</script>

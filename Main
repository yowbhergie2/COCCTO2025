<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <?!= include('Styles'); ?>
</head>
<body>
  <div class="app-container">
    <!-- Top Navigation Bar -->
    <div class="top-nav">
      <div class="nav-content">
        <div class="nav-left">
          <div class="logo-container">
            <div class="logo-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="logo-text">CompTime</div>
          </div>
          
          <div class="nav-menu">
            <div class="nav-link active" onclick="navigateTo('dashboard')" data-view="dashboard">
              <i class="fas fa-home"></i>
              <span>Dashboard</span>
            </div>
            <div class="nav-link" onclick="navigateTo('employees')" data-view="employees">
              <i class="fas fa-users"></i>
              <span>Employees</span>
            </div>
            <div class="nav-dropdown" id="cocDropdown">
              <div class="nav-dropdown-toggle">
                <i class="fas fa-business-time"></i>
                <span>COC</span>
                <i class="fas fa-chevron-down"></i>
              </div>
              <div class="nav-dropdown-menu">
                <div class="nav-dropdown-item" data-page="logovertime" data-view="logovertime">
                  <i class="fas fa-clock"></i>
                  <span>Log Overtime</span>
                </div>
                <div class="nav-dropdown-item disabled" data-view="generatecertificate">
                  <i class="fas fa-certificate"></i>
                  <span>Generate Certificate</span>
                </div>
                <div class="nav-dropdown-item disabled" data-view="logcto">
                  <i class="fas fa-calendar-check"></i>
                  <span>Log CTO</span>
                </div>
                <div class="nav-dropdown-item" data-page="uncertifiedreport" data-view="uncertifiedreport">
                  <i class="fas fa-list-alt"></i>
                  <span>Uncertified Report</span>
                </div>
              </div>
            </div>
            <!-- === END OF MODIFICATION === -->
            
            <div class="nav-link" onclick="navigateTo('reports')" data-view="reports">
              <i class="fas fa-chart-line"></i>
              <span>Reports</span>
            </div>
            <div class="nav-link" onclick="navigateTo('masterdata')" data-view="masterdata">
              <i class="fas fa-database"></i>
              <span>Master</span>
            </div>
          </div>
        </div>

        <div class="user-info">
          <div class="user-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div style="min-width: 0;">
            <div style="font-size: 0.8125rem; color: #697386;">Logged in</div>
            <div id="currentUser" style="font-size: 0.875rem; font-weight: 600; color: #1a1f36; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent"></div>
  </div>

  <script>
    let currentView = 'dashboard';
    let allEmployees = [];
    let selectedEmployee = null;
    let offices = [];
    let positions = [];

    // Initialize
    loadCurrentUser();
    loadDashboard();

    // Setup COC dropdown event listeners
    setupCOCDropdown();

    function loadCurrentUser() {
      google.script.run
        .withSuccessHandler(email => {
          const shortEmail = email.length > 24 ? email.substring(0, 24) + '...' : email;
          document.getElementById('currentUser').textContent = shortEmail;
          document.getElementById('currentUser').title = email;
        })
        .getCurrentUserEmail();
    }

    /**
     * Helper function to show a main loading spinner
     */
    function showMainContentSpinner() {
      document.getElementById('mainContent').innerHTML = `
        <div style="
          display: flex; 
          align-items: center; 
          justify-content: center; 
          height: calc(100vh - 200px); 
          color: #697386;
        ">
          <i class="fas fa-spinner fa-spin" style="font-size: 2.5rem; opacity: 0.5;"></i>
        </div>`;
    }

    /**
     * Setup COC dropdown functionality
     */
    function setupCOCDropdown() {
      const dropdown = document.getElementById('cocDropdown');
      const toggle = dropdown.querySelector('.nav-dropdown-toggle');
      const items = dropdown.querySelectorAll('.nav-dropdown-item:not(.disabled)');

      // Toggle dropdown on click
      toggle.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpen = dropdown.classList.contains('open');

        // Close all dropdowns
        document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));

        // Toggle this dropdown
        if (!isOpen) {
          dropdown.classList.add('open');
        }
      });

      // Handle menu item clicks
      items.forEach(item => {
        item.addEventListener('click', function(e) {
          e.stopPropagation();
          const page = this.getAttribute('data-page');
          if (page) {
            navigateToCOCPage(page);
          }
        });
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        if (!event.target.closest('.nav-dropdown')) {
          document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));
        }
      });
    }

    /**
     * Navigate to COC sub-page
     */
    function navigateToCOCPage(page) {
      // Close dropdown
      document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));

      // Update active states
      document.querySelectorAll('.nav-link').forEach(item => item.classList.remove('active'));
      document.querySelectorAll('.nav-dropdown-item').forEach(item => item.classList.remove('active'));
      document.querySelector(`.nav-dropdown-item[data-view="${page}"]`)?.classList.add('active');
      document.querySelector('#cocDropdown .nav-dropdown-toggle').classList.add('active');

      currentView = page;

      showMainContentSpinner();

      setTimeout(() => {
        switch(page) {
          case 'logovertime': loadLogOvertimeView(); break;
          case 'generatecertificate': loadGenerateCertificateView(); break;
          case 'logcto': loadLogCTOView(); break;
          case 'uncertifiedreport': loadUncertifiedReportView(); break;
        }
      }, 50);
    }

    /**
     * Main navigation function
     */
    function navigateTo(view) {
      // Don't reload if clicking the same view
      if (currentView === view) {
         closeAllDropdowns(); // Still close dropdown if a sub-link is clicked
         return;
      }

      // Close all dropdowns
      document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));

      // Clear dropdown active states
      document.querySelectorAll('.nav-dropdown-toggle').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.nav-dropdown-item').forEach(item => item.classList.remove('active'));

      document.querySelectorAll('.nav-link').forEach(item => item.classList.remove('active'));
      document.querySelector(`.nav-link[data-view="${view}"]`).classList.add('active');
      currentView = view;

      // *** FIX: Show spinner IMMEDIATELY ***
      showMainContentSpinner();

      setTimeout(() => {
        switch(view) {
          case 'dashboard': loadDashboard(); break;
          case 'employees': loadEmployeesView(); break;
          case 'reports': loadReportsView(); break;
          case 'masterdata': loadMasterDataView(); break;
        }
      }, 50); // 50ms delay
    }

    function loadDashboard() {
      google.script.run
        .withSuccessHandler(html => {
          document.getElementById('mainContent').innerHTML = html;
          loadDashboardStats();
        })
        .withFailureHandler(err => {
          document.getElementById('mainContent').innerHTML = `<p>Error loading dashboard: ${err.message}</p>`;
        })
        .include('Dashboard');
    }

    function loadEmployeesView() {
      google.script.run
        .withSuccessHandler(html => {
          document.getElementById('mainContent').innerHTML = html;
          loadEmployees();
          loadDropdownData();
        })
        .withFailureHandler(err => {
          document.getElementById('mainContent').innerHTML = `<p>Error loading employees: ${err.message}</p>`;
        })
        .include('Employees');
    }

    function loadLogOvertimeView() {
      google.script.run
        .withSuccessHandler(html => {
          document.getElementById('mainContent').innerHTML = html;
          // Initialize form after HTML is loaded
          if (typeof initLogOvertimeForm === 'function') {
            initLogOvertimeForm();
          }
        })
        .withFailureHandler(err => {
          document.getElementById('mainContent').innerHTML = `<p>Error loading Log Overtime: ${err.message}</p>`;
        })
        .include('LogOvertime');
    }

    function loadGenerateCertificateView() {
      google.script.run
        .withSuccessHandler(html => {
          document.getElementById('mainContent').innerHTML = html;
          // Initialize form after HTML is loaded
          if (typeof initGenerateCertificateForm === 'function') {
            initGenerateCertificateForm();
          }
        })
        .withFailureHandler(err => {
          document.getElementById('mainContent').innerHTML = `<p>Error loading Generate Certificate: ${err.message}</p>`;
        })
        .include('GenerateCertificate');
    }

    function loadLogCTOView() {
      google.script.run
        .withSuccessHandler(html => {
          document.getElementById('mainContent').innerHTML = html;
        })
        .withFailureHandler(err => {
          document.getElementById('mainContent').innerHTML = `<p>Error loading Log CTO: ${err.message}</p>`;
        })
        .include('LogCTO');
    }

    function loadUncertifiedReportView() {
      google.script.run
        .withSuccessHandler(html => {
          document.getElementById('mainContent').innerHTML = html;
          // Initialize report after HTML is loaded
          if (typeof loadUncertifiedReport === 'function') {
            loadUncertifiedReport();
          }
        })
        .withFailureHandler(err => {
          document.getElementById('mainContent').innerHTML = `<p>Error loading Uncertified Report: ${err.message}</p>`;
        })
        .include('UncertifiedReport');
    }

    // === NEW: Function to load specific COC placeholder pages ===
    function loadSpecificCOCView(viewName) {
      google.script.run
        .withSuccessHandler(html => {
          document.getElementById('mainContent').innerHTML = html;
        })
        .withFailureHandler(err => {
          document.getElementById('mainContent').innerHTML = `<p>Error loading view: ${err.message}</p>`;
        })
        .include(viewName); // e.g., 'COC_LogOvertime'
    }

    function loadReportsView() {
      google.script.run
        .withSuccessHandler(html => {
          document.getElementById('mainContent').innerHTML = html;
        })
        .withFailureHandler(err => {
          document.getElementById('mainContent').innerHTML = `<p>Error loading reports: ${err.message}</p>`;
        })
        .include('Reports');
    }

    function loadMasterDataView() {
      google.script.run
        .withSuccessHandler(html => {
          document.getElementById('mainContent').innerHTML = html;
          refreshMasterData();
        })
        .withFailureHandler(err => {
          document.getElementById('mainContent').innerHTML = `<p>Error loading master data: ${err.message}</p>`;
        })
        .include('MasterData');
    }

    function showAlert(message, type = 'success') {
      const colors = {
        /* Updated Theme: Indigo Success */
        success: { bg: '#e0e7ff', border: '#4f46e5', text: '#4338ca', icon: 'check-circle' },
        error: { bg: '#fee', border: '#ef4444', text: '#ef4444', icon: 'exclamation-circle' },
        info: { bg: '#e6f3ff', border: '#3b82f6', text: '#3b82f6', icon: 'info-circle' }
      };
      const color = colors[type];
      
      const alert = document.createElement('div');
      alert.style.cssText = `
        position: fixed; top: 5rem; right: 1.5rem; z-index: 200;
        background: ${color.bg}; border: 1px solid ${color.border}; color: ${color.text};
        padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-weight: 500; font-size: 0.9375rem; max-width: 400px;
        display: flex; align-items: center; gap: 0.75rem;
      `;
      alert.innerHTML = `<i class="fas fa-${color.icon}"></i><span>${message}</span>`;
      document.body.appendChild(alert);
      setTimeout(() => alert.remove(), 3000);
    }
  </script>

  <?!= include('EmployeesScript'); ?>
  <?!= include('DashboardScript'); ?>
  <?!= include('MasterDataScript'); ?>
  <?!= include('COCScript'); ?>
</body>
</html>
